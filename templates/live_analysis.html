{% extends "base.html" %}

{% block title %}Live Analysis - Wellness Monitor{% endblock %}

{% block extra_css %}
<style>
    #video-container {
        position: relative;
        max-width: 640px;
        margin: 0 auto;
        border-radius: 10px;
        overflow: hidden;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }
    
    #video {
        width: 100%;
        display: block;
    }
    
    #canvas {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
    }
    
    .wellness-indicator {
        border-radius: 10px;
        padding: 20px;
        margin-bottom: 20px;
        color: white;
        text-align: center;
    }
    
    .wellness-score {
        font-size: 2.5rem;
        font-weight: bold;
        margin: 10px 0;
    }
    
    .status-message {
        font-size: 1.1rem;
        margin-bottom: 15px;
    }
    
    .recommendation-card {
        border-left: 4px solid #0d6efd;
    }
    
    .face-landmark {
        position: absolute;
        width: 6px;
        height: 6px;
        background-color: #ff0000;
        border-radius: 50%;
        transform: translate(-50%, -50%);
    }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <div class="row mb-4">
        <div class="col-12 text-center">
            <h1 class="display-5">Live Face & Voice Analysis</h1>
            <p class="lead">Get real-time stress and fatigue analysis using your webcam and microphone</p>
        </div>
    </div>
    
    <div class="row">
        <!-- Video Feed Column -->
        <div class="col-lg-8">
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-primary text-white">
                    <i class="fas fa-video me-2"></i> Live Camera Feed
                </div>
                <div class="card-body p-0">
                    <div id="video-container">
                        <video id="video" autoplay muted playsinline></video>
                        <canvas id="canvas"></canvas>
                    </div>
                </div>
                <div class="card-footer bg-light">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <button id="startBtn" class="btn btn-success me-2">
                                <i class="fas fa-play me-1"></i> Start Analysis
                            </button>
                            <button id="stopBtn" class="btn btn-danger me-2" disabled>
                                <i class="fas fa-stop me-1"></i> Stop
                            </button>
                        </div>
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="audioToggle" checked>
                            <label class="form-check-label" for="audioToggle">Enable Voice Analysis</label>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Analysis Results -->
            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white">
                    <i class="fas fa-chart-bar me-2"></i> Analysis Results
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <div class="p-3 bg-light rounded">
                                <h5 class="text-center">Stress Level</h5>
                                <div class="progress" style="height: 25px;">
                                    <div id="stressBar" class="progress-bar bg-danger" role="progressbar" style="width: 0%;" 
                                         aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%</div>
                                </div>
                                <div id="stressLevel" class="text-center mt-2 fw-bold">-</div>
                            </div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <div class="p-3 bg-light rounded">
                                <h5 class="text-center">Fatigue Level</h5>
                                <div class="progress" style="height: 25px;">
                                    <div id="fatigueBar" class="progress-bar bg-warning" role="progressbar" style="width: 0%;" 
                                         aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%</div>
                                </div>
                                <div id="fatigueLevel" class="text-center mt-2 fw-bold">-</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mt-4">
                        <h5>Wellness Index</h5>
                        <div class="progress" style="height: 30px;">
                            <div id="wellnessBar" class="progress-bar progress-bar-striped progress-bar-animated" 
                                 role="progressbar" style="width: 0%;" 
                                 aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%</div>
                        </div>
                        <div id="wellnessStatus" class="text-center mt-2 fw-bold">
                            <i class="fas fa-info-circle text-primary"></i> Start analysis to see your wellness index
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Recommendations Column -->
        <div class="col-lg-4">
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-success text-white">
                    <i class="fas fa-lightbulb me-2"></i> Real-time Recommendations
                </div>
                <div class="card-body">
                    <div id="recommendations">
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            Start the analysis to receive personalized recommendations based on your stress and fatigue levels.
                        </div>
                    </div>
                    
                    <div id="breathingExercise" class="mt-4 d-none">
                        <h5 class="border-bottom pb-2">Breathing Exercise</h5>
                        <div id="breathingAnimation" class="text-center my-4">
                            <div class="breath-circle mx-auto" style="width: 150px; height: 150px; border-radius: 50%; 
                                background-color: #e3f2fd; display: flex; align-items: center; justify-content: center;
                                transition: transform 4s ease-in-out, background-color 2s ease-in-out;">
                                <span id="breathText" class="h4 mb-0">Breathe In</span>
                            </div>
                        </div>
                        <div id="breathInstructions" class="text-center">
                            <p class="mb-1">Follow the animation:</p>
                            <p class="mb-1"><i class="fas fa-arrow-up text-primary me-2"></i> Inhale (4s)</p>
                            <p class="mb-1"><i class="fas fa-pause text-primary me-2"></i> Hold (4s)</p>
                            <p class="mb-1"><i class="fas fa-arrow-down text-primary me-2"></i> Exhale (6s)</p>
                            <p class="mb-0"><i class="fas fa-pause text-primary me-2"></i> Hold (2s)</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="card shadow-sm">
                <div class="card-header bg-info text-white">
                    <i class="fas fa-history me-2"></i> Analysis History
                </div>
                <div class="card-body">
                    <div id="historyChart">
                        <p class="text-muted text-center my-4">
                            <i class="fas fa-chart-line fa-2x d-block mb-2"></i>
                            Analysis history will appear here
                        </p>
                        <canvas id="wellnessChart" height="200"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Global variables
let mediaStream = null;
let mediaRecorder = null;
let audioChunks = [];
let isAnalyzing = false;
let analysisInterval = null;
let wellnessHistory = [];
let currentWellnessIndex = 0;
let chart = null;

// DOM Elements
const video = document.getElementById('video');
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');
const startBtn = document.getElementById('startBtn');
const stopBtn = document.getElementById('stopBtn');
const audioToggle = document.getElementById('audioToggle');
const stressBar = document.getElementById('stressBar');
const fatigueBar = document.getElementById('fatigueBar');
const wellnessBar = document.getElementById('wellnessBar');
const stressLevel = document.getElementById('stressLevel');
const fatigueLevel = document.getElementById('fatigueLevel');
const wellnessStatus = document.getElementById('wellnessStatus');
const recommendations = document.getElementById('recommendations');
const breathingExercise = document.getElementById('breathingExercise');

// Start analysis
startBtn.addEventListener('click', async () => {
    try {
        // Request camera and microphone access
        const stream = await navigator.mediaDevices.getUserMedia({
            video: {
                width: { ideal: 1280 },
                height: { ideal: 720 },
                facingMode: 'user'
            },
            audio: audioToggle.checked
        });
        
        // Set up video stream
        video.srcObject = stream;
        mediaStream = stream;
        
        // Set canvas dimensions to match video
        video.onloadedmetadata = () => {
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
        };
        
        // Set up audio recording if enabled
        if (audioToggle.checked) {
            setupAudioRecording(stream);
        }
        
        // Update UI
        startBtn.disabled = true;
        stopBtn.disabled = false;
        isAnalyzing = true;
        
        // Start analysis loop
        startAnalysis();
        
    } catch (err) {
        console.error('Error accessing media devices:', err);
        alert('Could not access camera or microphone. Please check your permissions.');
    }
});

// Stop analysis
stopBtn.addEventListener('click', () => {
    stopAnalysis();
});

// Set up audio recording
function setupAudioRecording(stream) {
    const audioContext = new (window.AudioContext || window.webkitAudioContext)();
    const source = audioContext.createMediaStreamSource(stream);
    const processor = audioContext.createScriptProcessor(4096, 1, 1);
    
    source.connect(processor);
    processor.connect(audioContext.destination);
    
    processor.onaudioprocess = (e) => {
        if (!isAnalyzing) return;
        
        const inputData = e.inputBuffer.getChannelData(0);
        // Process audio data here for real-time analysis
        // This is a placeholder - implement actual audio analysis
    };
    
    // For longer recordings, we'd use MediaRecorder
    mediaRecorder = new MediaRecorder(stream);
    audioChunks = [];
    
    mediaRecorder.ondataavailable = (e) => {
        if (e.data.size > 0) {
            audioChunks.push(e.data);
            // Analyze audio chunk
            analyzeAudioChunk(e.data);
        }
    };
    
    mediaRecorder.start(1000); // Collect 1-second chunks
}

// Start analysis loop
function startAnalysis() {
    // Clear previous interval if any
    if (analysisInterval) {
        clearInterval(analysisInterval);
    }
    
    // Start processing frames
    analysisInterval = setInterval(processFrame, 1000); // Process every second
    
    // Initialize chart
    initChart();
    
    // Show initial recommendations
    updateRecommendations(0, 0, 100);
}

// Process video frame
function processFrame() {
    if (!isAnalyzing) return;
    
    // Draw video frame to canvas
    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
    
    // Get image data for processing
    const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
    
    // In a real app, we would send this to a face detection API
    // For now, we'll simulate face detection and analysis
    simulateFaceDetection();
    
    // Simulate getting analysis results
    const stress = Math.min(100, Math.max(0, 30 + Math.random() * 40)); // Random stress 30-70
    const fatigue = Math.min(100, Math.max(0, 20 + Math.random() * 50)); // Random fatigue 20-70
    const wellness = 100 - (0.6 * stress + 0.4 * fatigue) * 0.9; // Weighted wellness index
    
    // Update UI with results
    updateAnalysisResults(stress, fatigue, wellness);
    
    // Add to history
    addToHistory(stress, fatigue, wellness);
}

// Simulate face detection (for demo purposes)
function simulateFaceDetection() {
    // Draw a simple face outline (in a real app, this would be actual face detection)
    const centerX = canvas.width / 2 + (Math.random() * 40 - 20);
    const centerY = canvas.height / 2 + (Math.random() * 40 - 20);
    const radius = Math.min(canvas.width, canvas.height) * 0.3;
    
    // Draw face outline
    ctx.strokeStyle = '#00ff00';
    ctx.lineWidth = 3;
    ctx.beginPath();
    ctx.arc(centerX, centerY, radius, 0, 2 * Math.PI);
    ctx.stroke();
    
    // Draw eyes (simplified)
    const eyeRadius = radius * 0.15;
    const eyeY = centerY - radius * 0.2;
    
    // Left eye
    ctx.beginPath();
    ctx.arc(centerX - radius * 0.3, eyeY, eyeRadius, 0, 2 * Math.PI);
    ctx.stroke();
    
    // Right eye
    ctx.beginPath();
    ctx.arc(centerX + radius * 0.3, eyeY, eyeRadius, 0, 2 * Math.PI);
    ctx.stroke();
    
    // Draw mouth (simplified smile/frown based on stress)
    ctx.beginPath();
    const mouthCurve = Math.random() > 0.5 ? -1 : 1; // Random smile/frown
    ctx.arc(centerX, centerY + radius * 0.1, radius * 0.4, 0, Math.PI * mouthCurve, mouthCurve === 1);
    ctx.stroke();
}

// Update analysis results in the UI
function updateAnalysisResults(stress, fatigue, wellness) {
    // Update progress bars
    stressBar.style.width = `${stress}%`;
    stressBar.textContent = `${Math.round(stress)}%`;
    stressBar.className = `progress-bar ${getStressColorClass(stress)}`;
    
    fatigueBar.style.width = `${fatigue}%`;
    fatigueBar.textContent = `${Math.round(fatigue)}%`;
    fatigueBar.className = `progress-bar ${getFatigueColorClass(fatigue)}`;
    
    wellnessBar.style.width = `${wellness}%`;
    wellnessBar.textContent = `${Math.round(wellness)}%`;
    wellnessBar.className = `progress-bar ${getWellnessColorClass(wellness)}`;
    
    // Update text indicators
    stressLevel.textContent = getStressLevelText(stress);
    fatigueLevel.textContent = getFatigueLevelText(fatigue);
    wellnessStatus.innerHTML = getWellnessStatus(wellness);
    
    // Store current wellness index
    currentWellnessIndex = wellness;
    
    // Update recommendations
    updateRecommendations(stress, fatigue, wellness);
}

// Update recommendations based on analysis
function updateRecommendations(stress, fatigue, wellness) {
    let recommendationHtml = '';
    
    // Determine stress level
    if (stress > 70) {
        recommendationHtml += `
            <div class="alert alert-danger">
                <h5><i class="fas fa-exclamation-triangle me-2"></i> High Stress Detected</h5>
                <p class="mb-1">Your stress levels are high. Try these techniques:</p>
                <ul class="mb-0">
                    <li>Take 5 deep breaths</li>
                    <li>Step away from your screen for 5 minutes</li>
                    <li>Try the 4-7-8 breathing exercise below</li>
                </ul>
            </div>
        `;
    } else if (stress > 40) {
        recommendationHtml += `
            <div class="alert alert-warning">
                <h5><i class="fas fa-info-circle me-2"></i> Moderate Stress</h5>
                <p class="mb-1">Your stress levels are moderate. Consider:</p>
                <ul class="mb-0">
                    <li>Taking short breaks every hour</li>
                    <li>Practicing mindful breathing</li>
                    <li>Stretching your neck and shoulders</li>
                </ul>
            </div>
        `;
    } else {
        recommendationHtml += `
            <div class="alert alert-success">
                <h5><i class="fas fa-check-circle me-2"></i> Low Stress</h5>
                <p class="mb-0">Your stress levels are well managed. Keep up the good work!</p>
            </div>
        `;
    }
    
    // Add fatigue-specific recommendations
    if (fatigue > 70) {
        recommendationHtml += `
            <div class="alert alert-warning mt-3">
                <h5><i class="fas fa-tired me-2"></i> High Fatigue</h5>
                <p class="mb-1">You seem very tired. Consider:</p>
                <ul class="mb-0">
                    <li>Taking a short 10-15 minute power nap</li>
                    <li>Drinking a glass of water</li>
                    <li>Taking a short walk to refresh yourself</li>
                </ul>
            </div>
        `;
    } else if (fatigue > 40) {
        recommendationHtml += `
            <div class="alert alert-info mt-3">
                <h5><i class="fas fa-info-circle me-2"></i> Moderate Fatigue</h5>
                <p class="mb-1">You're showing signs of fatigue. Try:</p>
                <ul class="mb-0">
                    <li>Looking away from the screen every 20 minutes</li>
                    <li>Blinking more frequently to moisten your eyes</li>
                    <li>Stretching your arms and legs</li>
                </ul>
            </div>
        `;
    }
    
    // Update the recommendations div
    recommendations.innerHTML = recommendationHtml;
    
    // Show/hide breathing exercise based on stress level
    if (stress > 50) {
        breathingExercise.classList.remove('d-none');
        startBreathingExercise();
    } else {
        breathingExercise.classList.add('d-none');
    }
}

// Start breathing exercise animation
function startBreathingExercise() {
    const circle = document.querySelector('.breath-circle');
    const breathText = document.getElementById('breathText');
    
    if (!circle || !breathText) return;
    
    let isInhaling = true;
    
    function animateBreathing() {
        if (!isAnalyzing) return;
        
        if (isInhaling) {
            // Inhale
            circle.style.transform = 'scale(1.5)';
            circle.style.backgroundColor = '#c8e6c9';
            breathText.textContent = 'Breathe In';
            
            setTimeout(() => {
                // Hold
                breathText.textContent = 'Hold';
                
                setTimeout(() => {
                    // Exhale
                    isInhaling = false;
                    circle.style.transform = 'scale(1)';
                    circle.style.backgroundColor = '#e3f2fd';
                    breathText.textContent = 'Breathe Out';
                    
                    setTimeout(() => {
                        // Rest
                        breathText.textContent = 'Rest';
                        
                        setTimeout(() => {
                            isInhaling = true;
                            if (isAnalyzing) {
                                requestAnimationFrame(animateBreathing);
                            }
                        }, 2000); // Rest for 2 seconds
                    }, 6000); // Exhale for 6 seconds
                }, 4000); // Hold for 4 seconds
            }, 4000); // Inhale for 4 seconds
        } else {
            requestAnimationFrame(animateBreathing);
        }
    }
    
    // Start the animation
    animateBreathing();
}

// Initialize chart
function initChart() {
    const ctx = document.getElementById('wellnessChart').getContext('2d');
    
    chart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: [],
            datasets: [
                {
                    label: 'Stress',
                    data: [],
                    borderColor: '#dc3545',
                    backgroundColor: 'rgba(220, 53, 69, 0.1)',
                    tension: 0.3,
                    fill: true
                },
                {
                    label: 'Fatigue',
                    data: [],
                    borderColor: '#fd7e14',
                    backgroundColor: 'rgba(253, 126, 20, 0.1)',
                    tension: 0.3,
                    fill: true
                },
                {
                    label: 'Wellness',
                    data: [],
                    borderColor: '#198754',
                    backgroundColor: 'rgba(25, 135, 84, 0.1)',
                    tension: 0.3,
                    fill: true
                }
            ]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    position: 'top',
                },
                title: {
                    display: true,
                    text: 'Your Wellness Over Time'
                }
            },
            scales: {
                y: {
                    min: 0,
                    max: 100,
                    title: {
                        display: true,
                        text: 'Score (%)'
                    }
                }
            }
        }
    });
}

// Add data point to history and update chart
function addToHistory(stress, fatigue, wellness) {
    const now = new Date();
    const timeStr = now.getHours() + ':' + now.getMinutes().toString().padStart(2, '0');
    
    // Add to wellness history array
    wellnessHistory.push({
        time: timeStr,
        stress: stress,
        fatigue: fatigue,
        wellness: wellness
    });
    
    // Keep only the last 10 data points
    if (wellnessHistory.length > 10) {
        wellnessHistory.shift();
    }
    
    // Update chart
    updateChart();
}

// Update chart with current data
function updateChart() {
    if (!chart) return;
    
    const labels = wellnessHistory.map(entry => entry.time);
    const stressData = wellnessHistory.map(entry => entry.stress);
    const fatigueData = wellnessHistory.map(entry => entry.fatigue);
    const wellnessData = wellnessHistory.map(entry => entry.wellness);
    
    chart.data.labels = labels;
    chart.data.datasets[0].data = stressData;
    chart.data.datasets[1].data = fatigueData;
    chart.data.datasets[2].data = wellnessData;
    chart.update();
}

// Analyze audio chunk (placeholder for actual implementation)
function analyzeAudioChunk(audioData) {
    // In a real app, this would analyze the audio data
    // For now, we'll just log that we received audio data
    console.log('Received audio chunk:', audioData);
}

// Stop analysis
function stopAnalysis() {
    isAnalyzing = false;
    
    // Stop media streams
    if (mediaStream) {
        mediaStream.getTracks().forEach(track => track.stop());
        mediaStream = null;
    }
    
    // Stop media recorder
    if (mediaRecorder && mediaRecorder.state !== 'inactive') {
        mediaRecorder.stop();
        mediaRecorder = null;
    }
    
    // Clear analysis interval
    if (analysisInterval) {
        clearInterval(analysisInterval);
        analysisInterval = null;
    }
    
    // Reset UI
    startBtn.disabled = false;
    stopBtn.disabled = true;
    
    // Clear canvas
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    
    // Show message
    wellnessStatus.innerHTML = '<i class="fas fa-pause-circle text-secondary"></i> Analysis paused';
}

// Helper functions for getting status text and colors
function getStressLevelText(stress) {
    if (stress >= 70) return 'High';
    if (stress >= 40) return 'Moderate';
    return 'Low';
}

function getFatigueLevelText(fatigue) {
    if (fatigue >= 70) return 'High';
    if (fatigue >= 40) return 'Moderate';
    return 'Low';
}

function getWellnessStatus(wellness) {
    if (wellness >= 80) {
        return '<i class="fas fa-smile text-success"></i> Excellent wellness';
    } else if (wellness >= 60) {
        return '<i class="fas fa-meh text-warning"></i> Good wellness';
    } else if (wellness >= 40) {
        return '<i class="fas fa-frown text-warning"></i> Fair wellness';
    } else {
        return '<i class="fas fa-sad-tear text-danger"></i> Poor wellness';
    }
}

function getStressColorClass(stress) {
    if (stress >= 70) return 'bg-danger';
    if (stress >= 40) return 'bg-warning';
    return 'bg-success';
}

function getFatigueColorClass(fatigue) {
    if (fatigue >= 70) return 'bg-warning';
    if (fatigue >= 40) return 'bg-info';
    return 'bg-success';
}

function getWellnessColorClass(wellness) {
    if (wellness >= 80) return 'bg-success';
    if (wellness >= 60) return 'bg-info';
    if (wellness >= 40) return 'bg-warning';
    return 'bg-danger';
}

// Handle window resize
window.addEventListener('resize', () => {
    if (video.videoWidth > 0 && video.videoHeight > 0) {
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
    }
});

// Clean up on page unload
window.addEventListener('beforeunload', () => {
    stopAnalysis();
});
</script>
{% endblock %}
