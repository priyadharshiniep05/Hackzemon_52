{% extends "base.html" %}

{% block title %}Voice Analysis - Wellness Monitor{% endblock %}

{% block extra_css %}
<style>
    .recording-indicator {
        display: inline-block;
        width: 12px;
        height: 12px;
        border-radius: 50%;
        background-color: #dc3545;
        margin-right: 8px;
        opacity: 0;
        transition: opacity 0.3s;
    }
    
    .recording .recording-indicator {
        opacity: 1;
        animation: pulse 1.5s infinite;
    }
    
    @keyframes pulse {
        0% { transform: scale(0.95); opacity: 1; }
        50% { transform: scale(1.1); opacity: 0.7; }
        100% { transform: scale(0.95); opacity: 1; }
    }
    
    .analysis-result {
        transition: all 0.5s ease;
        opacity: 0;
        height: 0;
        overflow: hidden;
    }
    
    .analysis-result.show {
        opacity: 1;
        height: auto;
        padding: 20px 0;
    }
    
    .waveform-container {
        background-color: #f8f9fa;
        border-radius: 8px;
        padding: 15px;
        margin: 15px 0;
        position: relative;
        height: 120px;
    }
    
    #waveform {
        width: 100%;
        height: 100%;
    }
    
    .feature-meter {
        margin: 15px 0;
    }
    
    .feature-label {
        display: flex;
        justify-content: space-between;
        margin-bottom: 5px;
    }
    
    .feature-name {
        font-weight: 500;
    }
    
    .feature-value {
        font-family: monospace;
    }
    
    .pitch-tracker {
        position: relative;
        height: 60px;
        background-color: #f0f0f0;
        border-radius: 4px;
        margin: 10px 0;
        overflow: hidden;
    }
    
    .pitch-line {
        position: absolute;
        width: 2px;
        background-color: #4CAF50;
        bottom: 0;
    }
    
    .recommendation-card {
        border-left: 4px solid #0d6efd;
        margin: 15px 0;
    }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <div class="row mb-4">
        <div class="col-12 text-center">
            <h1 class="display-5">Voice Stress & Fatigue Analysis</h1>
            <p class="lead">Record your voice to analyze stress and fatigue levels through speech patterns</p>
        </div>
    </div>
    
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-primary text-white">
                    <i class="fas fa-microphone me-2"></i> Voice Recorder
                </div>
                <div class="card-body">
                    <div class="text-center mb-4">
                        <div id="recordingStatus" class="mb-3">
                            <span id="recordingIndicator" class="recording-indicator"></span>
                            <span id="statusText">Ready to record</span>
                        </div>
                        
                        <div class="btn-group" role="group">
                            <button id="startRecording" class="btn btn-danger">
                                <i class="fas fa-microphone me-2"></i> Start Recording
                            </button>
                            <button id="stopRecording" class="btn btn-secondary" disabled>
                                <i class="fas fa-stop me-2"></i> Stop
                            </button>
                        </div>
                        
                        <div class="mt-3 text-muted small">
                            <i class="fas fa-info-circle me-1"></i> 
                            Speak naturally for 10-30 seconds about your day or read a paragraph of text.
                        </div>
                    </div>
                    
                    <!-- Waveform Display -->
                    <div class="waveform-container">
                        <canvas id="waveform"></canvas>
                    </div>
                    
                    <!-- Recording Timer -->
                    <div class="text-center">
                        <div id="recordingTimer" class="h3 mb-0">00:00</div>
                        <div class="text-muted small">Recording duration</div>
                    </div>
                </div>
            </div>
            
            <!-- Analysis Results (initially hidden) -->
            <div id="analysisResults" class="analysis-result">
                <div class="card shadow-sm mb-4">
                    <div class="card-header bg-success text-white">
                        <i class="fas fa-chart-pie me-2"></i> Analysis Results
                    </div>
                    <div class="card-body">
                        <!-- Overall Wellness Score -->
                        <div class="text-center mb-4">
                            <div class="display-4 fw-bold text-primary" id="wellnessScore">-</div>
                            <div class="h5" id="wellnessLabel">Wellness Index</div>
                            <div class="progress mt-2" style="height: 10px;">
                                <div id="wellnessBar" class="progress-bar progress-bar-striped progress-bar-animated" 
                                     role="progressbar" style="width: 0%" 
                                     aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <h5 class="text-center">Stress Level</h5>
                                <div class="feature-meter">
                                    <div class="feature-label">
                                        <span class="feature-name">Voice Stability</span>
                                        <span id="voiceStability" class="feature-value">-</span>
                                    </div>
                                    <div class="progress" style="height: 8px;">
                                        <div id="stabilityBar" class="progress-bar bg-danger" 
                                             role="progressbar" style="width: 0%"></div>
                                    </div>
                                </div>
                                
                                <div class="feature-meter">
                                    <div class="feature-label">
                                        <span class="feature-name">Pitch Variability</span>
                                        <span id="pitchVariability" class="feature-value">-</span>
                                    </div>
                                    <div class="progress" style="height: 8px;">
                                        <div id="pitchBar" class="progress-bar bg-warning" 
                                             role="progressbar" style="width: 0%"></div>
                                    </div>
                                </div>
                                
                                <div class="text-center mt-3">
                                    <div class="h3" id="stressLevel">-</div>
                                    <div class="text-muted">Stress Level</div>
                                </div>
                            </div>
                            
                            <div class="col-md-6">
                                <h5 class="text-center">Fatigue Indicators</h5>
                                <div class="feature-meter">
                                    <div class="feature-label">
                                        <span class="feature-name">Speech Rate</span>
                                        <span id="speechRateValue" class="feature-value">-</span>
                                    </div>
                                    <div class="progress" style="height: 8px;">
                                        <div id="speechRateBar" class="progress-bar bg-info" 
                                             role="progressbar" style="width: 0%"></div>
                                    </div>
                                </div>
                                
                                <div class="feature-meter">
                                    <div class="feature-label">
                                        <span class="feature-name">Voice Quality</span>
                                        <span id="voiceQuality" class="feature-value">-</span>
                                    </div>
                                    <div class="progress" style="height: 8px;">
                                        <div id="qualityBar" class="progress-bar bg-success" 
                                             role="progressbar" style="width: 0%"></div>
                                    </div>
                                </div>
                                
                                <div class="text-center mt-3">
                                    <div class="h3" id="fatigueLevel">-</div>
                                    <div class="text-muted">Fatigue Level</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Pitch Tracker -->
                        <div class="mt-4">
                            <h6>Pitch Contour</h6>
                            <div class="pitch-tracker" id="pitchTracker">
                                <!-- Pitch lines will be added here by JavaScript -->
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Recommendations -->
                <div class="card shadow-sm mb-4">
                    <div class="card-header bg-info text-white">
                        <i class="fas fa-lightbulb me-2"></i> Recommendations
                    </div>
                    <div class="card-body">
                        <div id="recommendations">
                            <div class="text-center text-muted">
                                <i class="fas fa-microphone-alt fa-3x mb-3"></i>
                                <p>Complete a voice recording to get personalized recommendations.</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Analysis History -->
                <div class="card shadow-sm">
                    <div class="card-header bg-secondary text-white">
                        <i class="fas fa-history me-2"></i> Analysis History
                    </div>
                    <div class="card-body">
                        <canvas id="historyChart" height="200"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Global variables
let mediaRecorder;
let audioChunks = [];
let isRecording = false;
let audioContext;
let analyser;
let dataArray;
let canvasCtx;
let animationId;
let startTime;
let timerInterval;
let chart;

// DOM Elements
const startButton = document.getElementById('startRecording');
const stopButton = document.getElementById('stopRecording');
const recordingStatus = document.getElementById('recordingStatus');
const statusText = document.getElementById('statusText');
const recordingIndicator = document.getElementById('recordingIndicator');
const recordingTimer = document.getElementById('recordingTimer');
const waveformCanvas = document.getElementById('waveform');
const analysisResults = document.getElementById('analysisResults');

// Initialize when the page loads
document.addEventListener('DOMContentLoaded', () => {
    // Set up canvas for waveform
    canvasCtx = waveformCanvas.getContext('2d');
    waveformCanvas.width = waveformCanvas.offsetWidth;
    waveformCanvas.height = waveformCanvas.offsetHeight;
    
    // Initialize chart
    initChart();
    
    // Set up event listeners
    startButton.addEventListener('click', startRecording);
    stopButton.addEventListener('click', stopRecording);
    
    // Handle window resize
    window.addEventListener('resize', () => {
        waveformCanvas.width = waveformCanvas.offsetWidth;
        drawWaveform();
    });
});

// Start recording
async function startRecording() {
    try {
        // Request microphone access
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        
        // Set up audio context and analyser
        audioContext = new (window.AudioContext || window.webkitAudioContext)();
        analyser = audioContext.createAnalyser();
        const source = audioContext.createMediaStreamSource(stream);
        source.connect(analyser);
        analyser.fftSize = 2048;
        
        const bufferLength = analyser.frequencyBinCount;
        dataArray = new Uint8Array(bufferLength);
        
        // Set up media recorder
        mediaRecorder = new MediaRecorder(stream);
        audioChunks = [];
        
        mediaRecorder.ondataavailable = (event) => {
            if (event.data.size > 0) {
                audioChunks.push(event.data);
            }
        };
        
        mediaRecorder.onstop = processRecording;
        
        // Start recording
        mediaRecorder.start();
        isRecording = true;
        startTime = Date.now();
        
        // Update UI
        startButton.disabled = true;
        stopButton.disabled = false;
        recordingStatus.classList.add('recording');
        statusText.textContent = 'Recording...';
        
        // Start timer
        updateTimer();
        timerInterval = setInterval(updateTimer, 1000);
        
        // Start visualization
        drawWaveform();
        
    } catch (err) {
        console.error('Error accessing microphone:', err);
        alert('Could not access microphone. Please check your permissions.');
    }
}

// Stop recording
function stopRecording() {
    if (mediaRecorder && isRecording) {
        mediaRecorder.stop();
        isRecording = false;
        
        // Stop all tracks in the stream
        mediaRecorder.stream.getTracks().forEach(track => track.stop());
        
        // Stop timer
        clearInterval(timerInterval);
        
        // Update UI
        startButton.disabled = false;
        stopButton.disabled = true;
        recordingStatus.classList.remove('recording');
        statusText.textContent = 'Processing...';
        
        // Stop visualization
        cancelAnimationFrame(animationId);
    }
}

// Update recording timer
function updateTimer() {
    const elapsed = Math.floor((Date.now() - startTime) / 1000);
    const minutes = Math.floor(elapsed / 60).toString().padStart(2, '0');
    const seconds = (elapsed % 60).toString().padStart(2, '0');
    recordingTimer.textContent = `${minutes}:${seconds}`;
    
    // Stop after 2 minutes (safety limit)
    if (elapsed >= 120) {
        stopRecording();
    }
}

// Draw waveform visualization
function drawWaveform() {
    if (!isRecording) return;
    
    animationId = requestAnimationFrame(drawWaveform);
    
    analyser.getByteTimeDomainData(dataArray);
    
    canvasCtx.fillStyle = '#f8f9fa';
    canvasCtx.fillRect(0, 0, waveformCanvas.width, waveformCanvas.height);
    
    canvasCtx.lineWidth = 2;
    canvasCtx.strokeStyle = '#0d6efd';
    canvasCtx.beginPath();
    
    const sliceWidth = waveformCanvas.width * 1.0 / analyser.frequencyBinCount;
    let x = 0;
    
    for (let i = 0; i < analyser.frequencyBinCount; i++) {
        const v = dataArray[i] / 128.0;
        const y = v * waveformCanvas.height / 2;
        
        if (i === 0) {
            canvasCtx.moveTo(x, y);
        } else {
            canvasCtx.lineTo(x, y);
        }
        
        x += sliceWidth;
    }
    
    canvasCtx.lineTo(waveformCanvas.width, waveformCanvas.height / 2);
    canvasCtx.stroke();
}

// Process the recorded audio
async function processRecording() {
    try {
        // Show analysis section
        analysisResults.classList.add('show');
        
        // Create a blob from the audio chunks
        const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
        
        // In a real app, you would send this to your server for analysis
        // For now, we'll simulate analysis with random data
        simulateAnalysis(audioBlob);
        
    } catch (err) {
        console.error('Error processing recording:', err);
        statusText.textContent = 'Error processing recording';
    }
}

// Simulate analysis (replace with actual API call)
function simulateAnalysis(audioBlob) {
    // Show loading state
    statusText.textContent = 'Analyzing...';
    
    // Simulate API delay
    setTimeout(() => {
        // Generate random results for demo
        const stressScore = Math.floor(Math.random() * 40) + 30; // 30-70
        const fatigueScore = Math.floor(Math.random() * 40) + 20; // 20-60
        const wellnessIndex = 100 - (0.6 * stressScore + 0.4 * fatigueScore);
        
        // Update UI with results
        updateResults({
            stress: stressScore,
            fatigue: fatigueScore,
            wellness: Math.round(wellnessIndex),
            features: {
                stability: 80 - stressScore / 2 + Math.random() * 10,
                pitchVar: stressScore / 2 + Math.random() * 10,
                speechRate: 70 - fatigueScore / 2 + Math.random() * 20,
                voiceQuality: 80 - fatigueScore / 2 + Math.random() * 10
            }
        });
        
        // Update status
        statusText.textContent = 'Analysis complete';
        
        // Add to history
        addToHistory(stressScore, fatigueScore, wellnessIndex);
        
    }, 2000);
}

// Update UI with analysis results
function updateResults(results) {
    // Update wellness score
    document.getElementById('wellnessScore').textContent = results.wellness;
    document.getElementById('wellnessBar').style.width = `${results.wellness}%`;
    document.getElementById('wellnessBar').setAttribute('aria-valuenow', results.wellness);
    
    // Update stress indicators
    document.getElementById('voiceStability').textContent = 
        Math.round(results.features.stability) + '%';
    document.getElementById('pitchVariability').textContent = 
        Math.round(results.features.pitchVar) + '%';
    document.getElementById('stabilityBar').style.width = 
        `${100 - results.features.stability}%`;
    document.getElementById('pitchBar').style.width = 
        `${results.features.pitchVar}%`;
    document.getElementById('stressLevel').textContent = 
        getStressLevelText(results.stress);
    
    // Update fatigue indicators
    document.getElementById('speechRateValue').textContent = 
        Math.round(results.features.speechRate) + '%';
    document.getElementById('voiceQuality').textContent = 
        Math.round(results.features.voiceQuality) + '%';
    document.getElementById('speechRateBar').style.width = 
        `${100 - results.features.speechRate}%`;
    document.getElementById('qualityBar').style.width = 
        `${results.features.voiceQuality}%`;
    document.getElementById('fatigueLevel').textContent = 
        getFatigueLevelText(results.fatigue);
    
    // Update pitch tracker
    updatePitchTracker(results.stress, results.fatigue);
    
    // Update recommendations
    updateRecommendations(results.stress, results.fatigue, results.wellness);
}

// Update pitch tracker visualization
function updatePitchTracker(stress, fatigue) {
    const tracker = document.getElementById('pitchTracker');
    tracker.innerHTML = ''; // Clear previous
    
    const width = tracker.offsetWidth;
    const height = tracker.offsetHeight;
    const segmentWidth = 10;
    const segments = Math.floor(width / segmentWidth);
    
    // More variation with higher stress
    const stressFactor = 1 + (stress / 100) * 2;
    
    // Lower average pitch with higher fatigue
    const fatigueOffset = (fatigue / 100) * 0.6;
    
    for (let i = 0; i < segments; i++) {
        // Add some randomness with sine wave pattern
        const x = (i / segments) * Math.PI * 8;
        const variation = Math.sin(x) * (0.3 + Math.random() * 0.7) * stressFactor;
        const position = (0.5 + variation * 0.5 - fatigueOffset) * 100;
        
        const line = document.createElement('div');
        line.className = 'pitch-line';
        line.style.left = `${(i / segments) * 100}%`;
        line.style.height = `${Math.max(5, position)}%`;
        line.style.opacity = 0.7 - (i / segments) * 0.3;
        
        // Color based on position (blue to red)
        const hue = 240 - (position / 100) * 240;
        line.style.backgroundColor = `hsl(${hue}, 80%, 50%)`;
        
        tracker.appendChild(line);
    }
}

// Update recommendations based on results
function updateRecommendations(stress, fatigue, wellness) {
    const recommendationsDiv = document.getElementById('recommendations');
    let recommendationsHTML = '';
    
    // Stress recommendations
    if (stress > 70) {
        recommendationsHTML += `
            <div class="alert alert-danger">
                <h5><i class="fas fa-exclamation-triangle me-2"></i> High Stress Detected</h5>
                <p>Your voice shows signs of high stress. Consider these techniques:</p>
                <ul>
                    <li>Practice deep breathing exercises for 5 minutes</li>
                    <li>Take a short walk in nature</li>
                    <li>Try progressive muscle relaxation</li>
                </ul>
            </div>
        `;
    } else if (stress > 40) {
        recommendationsHTML += `
            <div class="alert alert-warning">
                <h5><i class="fas fa-info-circle me-2"></i> Moderate Stress</h5>
                <p>Your voice indicates some stress. Try these tips:</p>
                <ul>
                    <li>Take regular breaks from work</li>
                    <li>Practice mindfulness meditation</li>
                    <li>Stay hydrated throughout the day</li>
                </ul>
            </div>
        `;
    } else {
        recommendationsHTML += `
            <div class="alert alert-success">
                <h5><i class="fas fa-check-circle me-2"></i> Low Stress</h5>
                <p>Your stress levels appear well managed. Keep up the good work!</p>
            </div>
        `;
    }
    
    // Fatigue recommendations
    if (fatigue > 60) {
        recommendationsHTML += `
            <div class="alert alert-warning">
                <h5><i class="fas fa-tired me-2"></i> High Fatigue</h5>
                <p>Your voice suggests you may be tired. Consider:</p>
                <ul>
                    <li>Getting adequate sleep (7-9 hours)</li>
                    <li>Taking short breaks every hour</li>
                    <li>Staying hydrated and eating nutritious meals</li>
                </ul>
            </div>
        `;
    } else if (fatigue > 30) {
        recommendationsHTML += `
            <div class="alert alert-info">
                <h5><i class="fas fa-info-circle me-2"></i> Moderate Fatigue</h5>
                <p>You're showing some signs of fatigue. Try these tips:</p>
                <ul>
                    <li>Take a short break and stretch</li>
                    <li>Drink some water</li>
                    <li>Practice the 20-20-20 rule (every 20 minutes, look at something 20 feet away for 20 seconds)</li>
                </ul>
            </div>
        `;
    }
    
    // General wellness tips
    if (wellness < 60) {
        recommendationsHTML += `
            <div class="alert alert-secondary">
                <h5><i class="fas fa-heartbeat me-2"></i> Wellness Tips</h5>
                <ul class="mb-0">
                    <li>Practice gratitude daily</li>
                    <li>Engage in regular physical activity</li>
                    <li>Maintain social connections</li>
                    <li>Limit screen time before bed</li>
                </ul>
            </div>
        `;
    }
    
    recommendationsDiv.innerHTML = recommendationsHTML;
}

// Initialize chart
function initChart() {
    const ctx = document.getElementById('historyChart').getContext('2d');
    
    chart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: [],
            datasets: [
                {
                    label: 'Stress',
                    data: [],
                    borderColor: '#dc3545',
                    backgroundColor: 'rgba(220, 53, 69, 0.1)',
                    tension: 0.3,
                    fill: true
                },
                {
                    label: 'Fatigue',
                    data: [],
                    borderColor: '#fd7e14',
                    backgroundColor: 'rgba(253, 126, 20, 0.1)',
                    tension: 0.3,
                    fill: true
                },
                {
                    label: 'Wellness',
                    data: [],
                    borderColor: '#198754',
                    backgroundColor: 'rgba(25, 135, 84, 0.1)',
                    tension: 0.3,
                    fill: true
                }
            ]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    position: 'top',
                },
                title: {
                    display: true,
                    text: 'Your Voice Analysis History'
                }
            },
            scales: {
                y: {
                    min: 0,
                    max: 100,
                    title: {
                        display: true,
                        text: 'Score (%)'
                    }
                }
            }
        }
    });
}

// Add data point to history
function addToHistory(stress, fatigue, wellness) {
    const now = new Date();
    const timeStr = now.getHours() + ':' + now.getMinutes().toString().padStart(2, '0');
    
    // Add to chart data
    chart.data.labels.push(timeStr);
    chart.data.datasets[0].data.push(stress);
    chart.data.datasets[1].data.push(fatigue);
    chart.data.datasets[2].data.push(wellness);
    
    // Keep only the last 10 data points
    const maxPoints = 10;
    if (chart.data.labels.length > maxPoints) {
        chart.data.labels.shift();
        chart.data.datasets.forEach(dataset => dataset.data.shift());
    }
    
    // Update chart
    chart.update();
}

// Helper functions for text labels
function getStressLevelText(stress) {
    if (stress >= 70) return 'High';
    if (stress >= 40) return 'Moderate';
    return 'Low';
}

function getFatigueLevelText(fatigue) {
    if (fatigue >= 60) return 'High';
    if (fatigue >= 30) return 'Moderate';
    return 'Low';
}
</script>
{% endblock %}
