{% extends "base.html" %}

{% block title %}Wellness Graph - Wellness Monitor{% endblock %}

{% block extra_css %}
<style>
    .card {
        margin-bottom: 20px;
        border: none;
        box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    }
    
    .card-header {
        background-color: #f8f9fa;
        border-bottom: 1px solid #eee;
        font-weight: 600;
    }
    
    .chart-container {
        position: relative;
        height: 300px;
        margin-bottom: 30px;
    }
    
    .date-range-selector {
        margin-bottom: 20px;
    }
    
    .metric-card {
        text-align: center;
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 20px;
        color: white;
        transition: transform 0.2s;
    }
    
    .metric-card:hover {
        transform: translateY(-5px);
    }
    
    .metric-card .value {
        font-size: 2rem;
        font-weight: bold;
        margin: 10px 0;
    }
    
    .metric-card .label {
        font-size: 0.9rem;
        opacity: 0.9;
    }
    
    .trend-indicator {
        display: inline-flex;
        align-items: center;
        font-size: 0.9rem;
        margin-top: 5px;
    }
    
    .trend-up {
        color: #dc3545;
    }
    
    .trend-down {
        color: #198754;
    }
    
    .trend-neutral {
        color: #6c757d;
    }
    
    .insights-card {
        background-color: #f8f9fa;
        border-left: 4px solid #0d6efd;
        padding: 15px;
        margin-bottom: 20px;
        border-radius: 4px;
    }
    
    .insights-card h5 {
        color: #0a58ca;
        margin-top: 0;
    }
    
    .comparison-card {
        background-color: #fff;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 20px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    }
    
    .comparison-item {
        display: flex;
        justify-content: space-between;
        padding: 8px 0;
        border-bottom: 1px solid #eee;
    }
    
    .comparison-item:last-child {
        border-bottom: none;
    }
    
    .comparison-label {
        font-weight: 500;
    }
    
    .comparison-value {
        font-weight: bold;
    }
    
    .improvement {
        color: #198754;
    }
    
    .decline {
        color: #dc3545;
    }
    
    .no-change {
        color: #6c757d;
    }
    
    .export-btn {
        margin-left: 10px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <div class="row mb-4">
        <div class="col-12">
            <h1 class="display-5"><i class="fas fa-chart-line me-2"></i>Wellness Analytics</h1>
            <p class="lead">Track your wellness metrics and progress over time</p>
        </div>
    </div>
    
    <!-- Date Range Selector -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col-md-4 mb-2 mb-md-0">
                            <h6 class="mb-0">Date Range</h6>
                        </div>
                        <div class="col-md-6">
                            <div class="btn-group w-100" role="group">
                                <input type="radio" class="btn-check" name="dateRange" id="week" autocomplete="off" checked>
                                <label class="btn btn-outline-primary" for="week">Week</label>
                                
                                <input type="radio" class="btn-check" name="dateRange" id="month" autocomplete="off">
                                <label class="btn btn-outline-primary" for="month">Month</label>
                                
                                <input type="radio" class="btn-check" name="dateRange" id="quarter" autocomplete="off">
                                <label class="btn btn-outline-primary" for="quarter">3 Months</label>
                                
                                <input type="radio" class="btn-check" name="dateRange" id="year" autocomplete="off">
                                <label class="btn btn-outline-primary" for="year">Year</label>
                            </div>
                        </div>
                        <div class="col-md-2 mt-2 mt-md-0">
                            <div class="dropdown">
                                <button class="btn btn-outline-secondary dropdown-toggle w-100" type="button" id="exportDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                                    <i class="fas fa-download me-1"></i> Export
                                </button>
                                <ul class="dropdown-menu w-100" aria-labelledby="exportDropdown">
                                    <li><a class="dropdown-item" href="#" id="exportPdf"><i class="far fa-file-pdf me-2"></i>PDF</a></li>
                                    <li><a class="dropdown-item" href="#" id="exportCsv"><i class="fas fa-file-csv me-2"></i>CSV</a></li>
                                    <li><a class="dropdown-item" href="#" id="exportPng"><i class="far fa-image me-2"></i>Image (PNG)</a></li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Summary Cards -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="metric-card" style="background: linear-gradient(135deg, #4e73df 0%, #224abe 100%);">
                <div class="label">WELLNESS INDEX</div>
                <div class="value" id="wellnessScore">78</div>
                <div class="trend-indicator">
                    <i class="fas fa-arrow-up me-1"></i>
                    <span>5.2% from last week</span>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="metric-card" style="background: linear-gradient(135deg, #1cc88a 0%, #13855c 100%);">
                <div class="label">AVG. STRESS LEVEL</div>
                <div class="value" id="stressLevel">32%</div>
                <div class="trend-indicator trend-down">
                    <i class="fas fa-arrow-down me-1"></i>
                    <span>8.7% improvement</span>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="metric-card" style="background: linear-gradient(135deg, #f6c23e 0%, #dda20a 100%);">
                <div class="label">SLEEP QUALITY</div>
                <div class="value" id="sleepQuality">6.8</div>
                <div class="trend-indicator">
                    <i class="fas fa-arrow-up me-1"></i>
                    <span>1.2 points better</span>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="metric-card" style="background: linear-gradient(135deg, #e74a3b 0%, #be2617 100%);">
                <div class="label">ACTIVITY LEVEL</div>
                <div class="value" id="activityLevel">64%</div>
                <div class="trend-indicator trend-neutral">
                    <i class="fas fa-equals me-1"></i>
                    <span>No change</span>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Main Chart -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <span>Wellness Overview</span>
                    <div class="btn-group" role="group">
                        <button type="button" class="btn btn-sm btn-outline-secondary active" data-metric="all">All</button>
                        <button type="button" class="btn btn-sm btn-outline-secondary" data-metric="stress">Stress</button>
                        <button type="button" class="btn btn-sm btn-outline-secondary" data-metric="sleep">Sleep</button>
                        <button type="button" class="btn btn-sm btn-outline-secondary" data-metric="activity">Activity</button>
                        <button type="button" class="btn btn-sm btn-outline-secondary" data-metric="mood">Mood</button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="wellnessChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="row">
        <!-- Insights -->
        <div class="col-lg-8">
            <div class="card">
                <div class="card-header">
                    <i class="fas fa-lightbulb me-2"></i>Insights & Recommendations
                </div>
                <div class="card-body">
                    <div class="insights-card mb-4">
                        <h5><i class="fas fa-chart-line me-2"></i>Trend Analysis</h5>
                        <p>Your wellness score has been improving over the past 2 weeks, with a <strong>5.2% increase</strong> compared to the previous period. Your stress levels are decreasing, which is great for your overall well-being.</p>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="card h-100">
                                <div class="card-body">
                                    <h6><i class="fas fa-check-circle text-success me-2"></i>What's Working</h6>
                                    <ul class="mt-3">
                                        <li class="mb-2">Consistent sleep schedule</li>
                                        <li class="mb-2">Regular exercise routine</li>
                                        <li class="mb-2">Mindfulness practice</li>
                                        <li>Balanced nutrition</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card h-100">
                                <div class="card-body">
                                    <h6><i class="fas fa-exclamation-triangle text-warning me-2"></i>Areas to Improve</h6>
                                    <ul class="mt-3">
                                        <li class="mb-2">Screen time before bed</li>
                                        <li class="mb-2">Work-life balance</li>
                                        <li class="mb-2">Hydration levels</li>
                                        <li>Evening relaxation routine</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mt-4">
                        <h6><i class="fas fa-bullseye me-2"></i>Weekly Goals</h6>
                        <div class="progress mb-2" style="height: 10px;">
                            <div class="progress-bar bg-success" role="progressbar" style="width: 75%;" aria-valuenow="75" aria-valuemin="0" aria-valuemax="100"></div>
                        </div>
                        <p class="small text-muted">3 of 4 weekly goals completed</p>
                        
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" value="" id="goal1" checked>
                            <label class="form-check-label" for="goal1">
                                Complete 5 mindfulness sessions
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" value="" id="goal2" checked>
                            <label class="form-check-label" for="goal2">
                                Exercise for 150 minutes
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" value="" id="goal3" checked>
                            <label class="form-check-label" for="goal3">
                                Get 7+ hours of sleep for 5 nights
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" value="" id="goal4">
                            <label class="form-check-label" for="goal4">
                                Drink 8 glasses of water daily
                            </label>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Comparison and Trends -->
        <div class="col-lg-4">
            <div class="card mb-4">
                <div class="card-header">
                    <i class="fas fa-exchange-alt me-2"></i>Period Comparison
                </div>
                <div class="card-body">
                    <div class="comparison-card">
                        <div class="comparison-item">
                            <span class="comparison-label">Wellness Score</span>
                            <span class="comparison-value improvement">+5.2% <i class="fas fa-arrow-up"></i></span>
                        </div>
                        <div class="comparison-item">
                            <span class="comparison-label">Stress Level</span>
                            <span class="comparison-value improvement">-8.7% <i class="fas fa-arrow-down"></i></span>
                        </div>
                        <div class="comparison-item">
                            <span class="comparison-label">Sleep Quality</span>
                            <span class="comparison-value improvement">+1.2 <i class="fas fa-arrow-up"></i></span>
                        </div>
                        <div class="comparison-item">
                            <span class="comparison-label">Activity Level</span>
                            <span class="comparison-value no-change">0% <i class="fas fa-equals"></i></span>
                        </div>
                        <div class="comparison-item">
                            <span class="comparison-label">Mood</span>
                            <span class="comparison-value improvement">+3.5% <i class="fas fa-arrow-up"></i></span>
                        </div>
                    </div>
                    <p class="small text-muted mb-0">Compared to previous period</p>
                </div>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <i class="fas fa-chart-pie me-2"></i>Wellness Breakdown
                </div>
                <div class="card-body">
                    <div class="chart-container" style="height: 250px;">
                        <canvas id="wellnessBreakdown"></canvas>
                    </div>
                    <div class="mt-3">
                        <div class="d-flex align-items-center mb-2">
                            <div class="me-2" style="width: 12px; height: 12px; background-color: #4e73df; border-radius: 2px;"></div>
                            <small>Physical: 35%</small>
                        </div>
                        <div class="d-flex align-items-center mb-2">
                            <div class="me-2" style="width: 12px; height: 12px; background-color: #1cc88a; border-radius: 2px;"></div>
                            <small>Mental: 28%</small>
                        </div>
                        <div class="d-flex align-items-center mb-2">
                            <div class="me-2" style="width: 12px; height: 12px; background-color: #f6c23e; border-radius: 2px;"></div>
                            <small>Emotional: 22%</small>
                        </div>
                        <div class="d-flex align-items-center">
                            <div class="me-2" style="width: 12px; height: 12px; background-color: #e74a3b; border-radius: 2px;"></div>
                            <small>Social: 15%</small>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="card mt-4">
                <div class="card-header">
                    <i class="fas fa-trophy me-2"></i>Achievements
                </div>
                <div class="card-body">
                    <div class="d-flex align-items-center mb-3">
                        <div class="me-3 text-warning">
                            <i class="fas fa-trophy fa-2x"></i>
                        </div>
                        <div>
                            <h6 class="mb-0">Consistency Champion</h6>
                            <small class="text-muted">Logged in for 7+ days in a row</small>
                        </div>
                    </div>
                    <div class="d-flex align-items-center mb-3">
                        <div class="me-3 text-secondary">
                            <i class="fas fa-moon fa-2x"></i>
                        </div>
                        <div>
                            <h6 class="mb-0">Sleep Master</h6>
                            <small class="text-muted">Achieved 8 hours of sleep 5 nights in a row</small>
                        </div>
                    </div>
                    <div class="d-flex align-items-center">
                        <div class="me-3 text-info">
                            <i class="fas fa-heartbeat fa-2x"></i>
                        </div>
                        <div>
                            <h6 class="mb-0">Stress Buster</h6>
                            <small class="text-muted">Reduced stress levels by 10% this week</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// Initialize when the page loads
document.addEventListener('DOMContentLoaded', function() {
    // Initialize main chart
    initWellnessChart();
    
    // Initialize breakdown chart
    initBreakdownChart();
    
    // Set up event listeners
    setupEventListeners();
});

// Initialize main wellness chart
function initWellnessChart() {
    const ctx = document.getElementById('wellnessChart').getContext('2d');
    
    // Generate labels for the past 7 days
    const labels = [];
    const today = new Date();
    for (let i = 6; i >= 0; i--) {
        const date = new Date(today);
        date.setDate(date.getDate() - i);
        labels.push(date.toLocaleDateString('en-US', { weekday: 'short' }));
    }
    
    // Sample data - in a real app, this would come from your backend
    const stressData = [45, 42, 40, 38, 36, 34, 32];
    const sleepData = [6.2, 6.5, 6.8, 7.1, 6.9, 7.2, 7.0];
    const activityData = [60, 62, 65, 63, 64, 66, 64];
    const moodData = [68, 70, 72, 73, 75, 76, 78];
    
    // Create the chart
    window.wellnessChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [
                {
                    label: 'Stress Level',
                    data: stressData,
                    borderColor: '#e74a3b',
                    backgroundColor: 'rgba(231, 74, 59, 0.1)',
                    tension: 0.3,
                    fill: true,
                    yAxisID: 'y',
                    hidden: false
                },
                {
                    label: 'Sleep Quality',
                    data: sleepData,
                    borderColor: '#36b9cc',
                    backgroundColor: 'rgba(54, 185, 204, 0.1)',
                    tension: 0.3,
                    fill: false,
                    yAxisID: 'y1',
                    hidden: true
                },
                {
                    label: 'Activity Level',
                    data: activityData,
                    borderColor: '#f6c23e',
                    backgroundColor: 'rgba(246, 194, 62, 0.1)',
                    tension: 0.3,
                    fill: false,
                    yAxisID: 'y',
                    hidden: true
                },
                {
                    label: 'Mood',
                    data: moodData,
                    borderColor: '#1cc88a',
                    backgroundColor: 'rgba(28, 200, 138, 0.1)',
                    tension: 0.3,
                    fill: false,
                    yAxisID: 'y',
                    hidden: true
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: {
                mode: 'index',
                intersect: false,
            },
            plugins: {
                tooltip: {
                    mode: 'index',
                    intersect: false,
                    callbacks: {
                        label: function(context) {
                            let label = context.dataset.label || '';
                            if (label) {
                                label += ': ';
                            }
                            if (context.parsed.y !== null) {
                                if (context.dataset.label === 'Sleep Quality') {
                                    label += context.parsed.y.toFixed(1) + ' hours';
                                } else if (context.dataset.label === 'Stress Level') {
                                    label += context.parsed.y + '%';
                                } else {
                                    label += context.parsed.y + '%';
                                }
                            }
                            return label;
                        }
                    }
                },
                legend: {
                    position: 'bottom',
                    onClick: function(e, legendItem, legend) {
                        // Keep the default behavior for toggling visibility
                        const index = legendItem.datasetIndex;
                        const ci = legend.chart;
                        const meta = ci.getDatasetMeta(index);
                        
                        // Toggle the hidden property
                        meta.hidden = meta.hidden === null ? !ci.data.datasets[index].hidden : null;
                        
                        // Update the chart
                        ci.update();
                        
                        // Toggle the active class on the button
                        const buttons = document.querySelectorAll('[data-metric]');
                        buttons.forEach(btn => {
                            if (btn.dataset.metric === 'all') {
                                btn.classList.remove('active');
                            } else if (btn.dataset.metric === 'stress' && index === 0) {
                                btn.classList.toggle('active', !meta.hidden);
                            } else if (btn.dataset.metric === 'sleep' && index === 1) {
                                btn.classList.toggle('active', !meta.hidden);
                            } else if (btn.dataset.metric === 'activity' && index === 2) {
                                btn.classList.toggle('active', !meta.hidden);
                            } else if (btn.dataset.metric === 'mood' && index === 3) {
                                btn.classList.toggle('active', !meta.hidden);
                            }
                        });
                    }
                }
            },
            scales: {
                x: {
                    grid: {
                        display: false
                    }
                },
                y: {
                    type: 'linear',
                    display: true,
                    position: 'left',
                    title: {
                        display: true,
                        text: 'Percentage (%)',
                        color: '#6c757d'
                    },
                    min: 0,
                    max: 100,
                    grid: {
                        drawOnChartArea: true
                    }
                },
                y1: {
                    type: 'linear',
                    display: false,
                    position: 'right',
                    title: {
                        display: true,
                        text: 'Hours',
                        color: '#6c757d'
                    },
                    min: 0,
                    max: 10,
                    grid: {
                        drawOnChartArea: false
                    }
                }
            }
        }
    });
}

// Initialize breakdown chart
function initBreakdownChart() {
    const ctx = document.getElementById('wellnessBreakdown').getContext('2d');
    
    window.breakdownChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: ['Physical', 'Mental', 'Emotional', 'Social'],
            datasets: [{
                data: [35, 28, 22, 15],
                backgroundColor: ['#4e73df', '#1cc88a', '#f6c23e', '#e74a3b'],
                hoverBackgroundColor: ['#2e59d9', '#17a673', '#dda20a', '#be2617'],
                hoverBorderColor: 'rgba(234, 236, 244, 1)',
                borderWidth: 1
            }]
        },
        options: {
            maintainAspectRatio: false,
            cutout: '70%',
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return `${context.label}: ${context.raw}%`;
                        }
                    }
                }
            }
        }
    });
}

// Set up event listeners
function setupEventListeners() {
    // Date range selector
    document.querySelectorAll('input[name="dateRange"]').forEach(radio => {
        radio.addEventListener('change', function() {
            // In a real app, this would fetch new data based on the selected range
            console.log('Date range changed to:', this.id);
            
            // For demo purposes, just show a loading state
            const chart = window.wellnessChart;
            chart.data.datasets.forEach(dataset => {
                dataset.data = dataset.data.map(() => Math.random() * 50 + 25);
            });
            chart.update();
        });
    });
    
    // Metric filter buttons
    document.querySelectorAll('[data-metric]').forEach(btn => {
        btn.addEventListener('click', function() {
            const metric = this.dataset.metric;
            const chart = window.wellnessChart;
            
            // Toggle active class
            if (metric === 'all') {
                // Show all metrics
                chart.data.datasets.forEach((dataset, i) => {
                    const meta = chart.getDatasetMeta(i);
                    meta.hidden = null;
                    chart.data.datasets[i].hidden = false;
                });
                
                // Update button states
                document.querySelectorAll('[data-metric]').forEach(b => {
                    b.classList.remove('active');
                });
                this.classList.add('active');
            } else {
                // Toggle the specific metric
                const index = ['stress', 'sleep', 'activity', 'mood'].indexOf(metric);
                if (index !== -1) {
                    const meta = chart.getDatasetMeta(index);
                    meta.hidden = !meta.hidden;
                    
                    // Update button states
                    const allButtons = document.querySelectorAll('[data-metric]');
                    allButtons.forEach(b => {
                        if (b.dataset.metric === 'all') {
                            b.classList.remove('active');
                        } else if (b.dataset.metric === metric) {
                            b.classList.toggle('active');
                        }
                    });
                    
                    // Check if all metrics are hidden
                    const allHidden = chart.data.datasets.every((dataset, i) => {
                        const meta = chart.getDatasetMeta(i);
                        return meta.hidden === true || chart.data.datasets[i].hidden === true;
                    });
                    
                    if (allHidden) {
                        // If all are hidden, show all
                        chart.data.datasets.forEach((dataset, i) => {
                            const meta = chart.getDatasetMeta(i);
                            meta.hidden = null;
                            chart.data.datasets[i].hidden = false;
                        });
                        
                        // Update button states
                        document.querySelectorAll('[data-metric]').forEach(b => {
                            b.classList.remove('active');
                        });
                        document.querySelector('[data-metric="all"]').classList.add('active');
                    }
                }
            }
            
            chart.update();
        });
    });
    
    // Export buttons
    document.getElementById('exportPdf').addEventListener('click', function(e) {
        e.preventDefault();
        alert('Exporting to PDF...');
        // In a real app, this would generate and download a PDF
    });
    
    document.getElementById('exportCsv').addEventListener('click', function(e) {
        e.preventDefault();
        alert('Exporting to CSV...');
        // In a real app, this would generate and download a CSV
    });
    
    document.getElementById('exportPng').addEventListener('click', function(e) {
        e.preventDefault();
        alert('Exporting to PNG...');
        // In a real app, this would generate and download a PNG
    });
}
</script>
{% endblock %}
